// ü¶à SuperOdds Monitor Extension - Popup Script
console.log('ü¶à Popup carregado!');

// Estado da aplica√ß√£o
let isMonitoring = false;
let currentConfig = {
  interval: 1,
  dashboardUrl: ''
};

// Elementos DOM
const elements = {
  statusDot: document.getElementById('statusDot'),
  statusText: document.getElementById('statusText'),
  lastCheck: document.getElementById('lastCheck'),
  oddsCount: document.getElementById('oddsCount'),
  intervalSelect: document.getElementById('intervalSelect'),
  dashboardUrl: document.getElementById('dashboardUrl'),
  startBtn: document.getElementById('startBtn'),
  stopBtn: document.getElementById('stopBtn'),
  checkBtn: document.getElementById('checkBtn'),
  highlightBtn: document.getElementById('highlightBtn'),
  openDashboard: document.getElementById('openDashboard'),
  clearData: document.getElementById('clearData')
};

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üì± Inicializando popup...');
  
  await loadConfig();
  await updateStatus();
  bindEvents();
  
  console.log('‚úÖ Popup inicializado');
});

// Carrega configura√ß√µes salvas
async function loadConfig() {
  try {
    const data = await chrome.storage.local.get([
      'isMonitoring', 
      'interval', 
      'dashboardUrl',
      'lastCheck',
      'lastOdds'
    ]);
    
    isMonitoring = data.isMonitoring || false;
    currentConfig.interval = data.interval || 1;
    currentConfig.dashboardUrl = data.dashboardUrl || '';
    
    // Atualiza UI com configura√ß√µes
    elements.intervalSelect.value = currentConfig.interval;
    elements.dashboardUrl.value = currentConfig.dashboardUrl;
    
    // Atualiza dados de status
    if (data.lastCheck) {
      const lastCheckTime = new Date(data.lastCheck);
      elements.lastCheck.textContent = lastCheckTime.toLocaleTimeString();
    }
    
    if (data.lastOdds) {
      elements.oddsCount.textContent = data.lastOdds.length || 0;
    }
    
    console.log('‚öôÔ∏è Configura√ß√µes carregadas:', currentConfig);
    
  } catch (error) {
    console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
  }
}

// Salva configura√ß√µes
async function saveConfig() {
  try {
    currentConfig.interval = parseFloat(elements.intervalSelect.value);
    currentConfig.dashboardUrl = elements.dashboardUrl.value.trim();
    
    await chrome.storage.local.set({
      interval: currentConfig.interval,
      dashboardUrl: currentConfig.dashboardUrl
    });
    
    console.log('üíæ Configura√ß√µes salvas:', currentConfig);
    
  } catch (error) {
    console.error('‚ùå Erro ao salvar configura√ß√µes:', error);
  }
}

// Atualiza status da interface
async function updateStatus() {
  try {
    // Solicita status do background script
    const response = await chrome.runtime.sendMessage({ action: 'status' });
    
    if (response.success) {
      isMonitoring = response.isMonitoring;
      
      // Atualiza indicadores visuais
      if (isMonitoring) {
        elements.statusDot.className = 'status-dot monitoring';
        elements.statusText.textContent = `Monitorando (${currentConfig.interval}min)`;
        elements.startBtn.disabled = true;
        elements.stopBtn.disabled = false;
      } else {
        elements.statusDot.className = 'status-dot';
        elements.statusText.textContent = 'Parado';
        elements.startBtn.disabled = false;
        elements.stopBtn.disabled = true;
      }
      
      // Atualiza contadores
      if (response.lastOdds !== undefined) {
        elements.oddsCount.textContent = response.lastOdds;
      }
      
    } else {
      // Erro no status
      elements.statusDot.className = 'status-dot error';
      elements.statusText.textContent = 'Erro';
    }
    
  } catch (error) {
    console.error('‚ùå Erro ao atualizar status:', error);
    elements.statusDot.className = 'status-dot error';
    elements.statusText.textContent = 'Erro de comunica√ß√£o';
  }
}

// Eventos da interface
function bindEvents() {
  // Bot√£o Iniciar
  elements.startBtn.addEventListener('click', async () => {
    try {
      await saveConfig();
      
      // Valida se tem aba do BETesporte aberta
      const tabs = await chrome.tabs.query({ url: "https://betesporte.bet.br/*" });
      
      if (tabs.length === 0) {
        showMessage('‚ö†Ô∏è Abra uma aba do BETesporte primeiro!', 'warning');
        return;
      }
      
      showMessage('üöÄ Iniciando monitoramento...', 'info');
      
      const response = await chrome.runtime.sendMessage({
        action: 'start',
        interval: currentConfig.interval,
        dashboardUrl: currentConfig.dashboardUrl
      });
      
      if (response.success) {
        showMessage('‚úÖ Monitoramento iniciado!', 'success');
        await updateStatus();
      } else {
        showMessage('‚ùå Erro ao iniciar', 'error');
      }
      
    } catch (error) {
      console.error('‚ùå Erro ao iniciar:', error);
      showMessage('‚ùå Erro: ' + error.message, 'error');
    }
  });

  // Bot√£o Parar
  elements.stopBtn.addEventListener('click', async () => {
    try {
      showMessage('‚èπÔ∏è Parando monitoramento...', 'info');
      
      const response = await chrome.runtime.sendMessage({ action: 'stop' });
      
      if (response.success) {
        showMessage('‚èπÔ∏è Monitoramento parado', 'success');
        await updateStatus();
      } else {
        showMessage('‚ùå Erro ao parar', 'error');
      }
      
    } catch (error) {
      console.error('‚ùå Erro ao parar:', error);
      showMessage('‚ùå Erro: ' + error.message, 'error');
    }
  });

  // Bot√£o Screenshot Agora
  elements.checkBtn.addEventListener('click', async () => {
    try {
      // Valida se tem aba do BETesporte
      const tabs = await chrome.tabs.query({ url: "https://betesporte.bet.br/*" });
      
      if (tabs.length === 0) {
        showMessage('‚ö†Ô∏è Abra uma aba do BETesporte primeiro!', 'warning');
        return;
      }
      
      showMessage('üì∏ Tirando screenshot...', 'info');
      
      const response = await chrome.runtime.sendMessage({ action: 'check' });
      
      if (response.success) {
        showMessage('üì∏ Screenshot processado!', 'success');
        await updateStatus();
      } else {
        showMessage('‚ùå Erro no screenshot', 'error');
      }
      
    } catch (error) {
      console.error('‚ùå Erro no screenshot:', error);
      showMessage('‚ùå Erro: ' + error.message, 'error');
    }
  });

  // Bot√£o Destacar Odds
  elements.highlightBtn.addEventListener('click', async () => {
    try {
      const tabs = await chrome.tabs.query({ 
        active: true, 
        currentWindow: true,
        url: "https://betesporte.bet.br/*" 
      });
      
      if (tabs.length === 0) {
        showMessage('‚ö†Ô∏è V√° para uma aba do BETesporte!', 'warning');
        return;
      }
      
      // Envia mensagem para content script
      const response = await chrome.tabs.sendMessage(tabs[0].id, {
        action: 'highlight_odds'
      });
      
      if (response && response.success) {
        showMessage(`üéØ ${response.count} SuperOdds destacadas!`, 'success');
      } else {
        showMessage('‚ö†Ô∏è Nenhuma SuperOdd encontrada', 'warning');
      }
      
    } catch (error) {
      console.error('‚ùå Erro ao destacar:', error);
      showMessage('‚ùå Erro: ' + error.message, 'error');
    }
  });

  // Link Dashboard
  elements.openDashboard.addEventListener('click', (e) => {
    e.preventDefault();
    
    if (currentConfig.dashboardUrl) {
      chrome.tabs.create({ url: currentConfig.dashboardUrl });
    } else {
      showMessage('‚ö†Ô∏è Configure a URL do dashboard primeiro', 'warning');
    }
  });

  // Limpar Dados
  elements.clearData.addEventListener('click', async (e) => {
    e.preventDefault();
    
    if (confirm('üóëÔ∏è Limpar todos os dados salvos?')) {
      try {
        await chrome.storage.local.clear();
        showMessage('üóëÔ∏è Dados limpos!', 'success');
        
        // Reseta interface
        elements.dashboardUrl.value = '';
        elements.intervalSelect.value = '1';
        elements.oddsCount.textContent = '--';
        elements.lastCheck.textContent = '--';
        
        currentConfig = { interval: 1, dashboardUrl: '' };
        
      } catch (error) {
        console.error('‚ùå Erro ao limpar:', error);
        showMessage('‚ùå Erro ao limpar dados', 'error');
      }
    }
  });

  // Salva configura√ß√µes quando mudam
  elements.intervalSelect.addEventListener('change', saveConfig);
  elements.dashboardUrl.addEventListener('blur', saveConfig);
}

// Mostra mensagens tempor√°rias
function showMessage(message, type = 'info') {
  console.log(`üì¢ ${message}`);
  
  // Remove mensagem anterior se existir
  const existing = document.querySelector('.temp-message');
  if (existing) existing.remove();
  
  // Cria nova mensagem
  const messageEl = document.createElement('div');
  messageEl.className = `temp-message ${type}`;
  messageEl.textContent = message;
  
  // Estilos
  messageEl.style.cssText = `
    position: fixed;
    top: 10px;
    left: 10px;
    right: 10px;
    padding: 12px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    text-align: center;
    z-index: 1000;
    animation: slideDown 0.3s ease-out;
    ${getMessageStyles(type)}
  `;
  
  document.body.appendChild(messageEl);
  
  // Remove ap√≥s 3 segundos
  setTimeout(() => {
    if (messageEl.parentNode) {
      messageEl.style.animation = 'slideUp 0.3s ease-in';
      setTimeout(() => messageEl.remove(), 300);
    }
  }, 3000);
}

function getMessageStyles(type) {
  switch (type) {
    case 'success':
      return 'background: #22c55e; color: white;';
    case 'error':
      return 'background: #dc2626; color: white;';
    case 'warning':
      return 'background: #f59e0b; color: white;';
    default:
      return 'background: #3b82f6; color: white;';
  }
}

// Adiciona anima√ß√µes CSS
const style = document.createElement('style');
style.textContent = `
  @keyframes slideDown {
    from { transform: translateY(-100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  @keyframes slideUp {
    from { transform: translateY(0); opacity: 1; }
    to { transform: translateY(-100%); opacity: 0; }
  }
`;
document.head.appendChild(style);

// Atualiza status periodicamente
setInterval(updateStatus, 5000);

console.log('‚úÖ Popup script carregado completamente!');
